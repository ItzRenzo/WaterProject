<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Water - RJane Water Kiosk</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../Css/code_order.css">
</head>

<body>
    <div class="kiosk-container">
        <!-- Header with back button -->
        <header class="kiosk-header">
            <a href="Home.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>Order Water</h1>
            <!-- Added logout link -->
            <a href="../Controllers/Logout.php" class="logout-link">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </header>

        <!-- Main Content -->
        <main class="kiosk-main">
            <div class="order-tabs">
                <div class="tab active" data-tab="products">1. Select Product</div>
                <div class="tab" data-tab="customer">2. Your Details</div>
                <div class="tab" data-tab="payment">3. Payment</div>
                <div class="tab" data-tab="review">4. Review Order</div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="tab-products">
                <h3 class="section-title">Gallon Containers</h3>
                <div class="products-grid">
                    <!-- Product 1 -->
                    <div class="product-card" data-id="mineral" data-price="35.00">
                        <div class="product-img">
                            <img src="../../images/galon.png" alt="Mineral Water Gallon" class="product-image">
                        </div>
                        <div class="product-info">
                            <h3>Mineral Water</h3>
                            <div class="price">₱35.00</div>
                            <div class="description">Natural minerals and electrolytes</div>
                            <div class="product-actions">
                                <div class="quantity-inline">
                                    <button class="qty-small-btn decrease-inline">-</button>
                                    <span class="qty-inline-value">1</span>
                                    <button class="qty-small-btn increase-inline">+</button>
                                </div>
                                <button class="btn btn-sm btn-primary add-to-cart">Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Product 2 -->
                    <div class="product-card" data-id="purified" data-price="25.00">
                        <div class="product-img">
                            <img src="../../images/galon.png" alt="Purified Water Gallon" class="product-image">
                        </div>
                        <div class="product-info">
                            <h3>Purified Water</h3>
                            <div class="price">₱25.00</div>
                            <div class="description">Clean and pure drinking water</div>
                            <div class="product-actions">
                                <div class="quantity-inline">
                                    <button class="qty-small-btn decrease-inline">-</button>
                                    <span class="qty-inline-value">1</span>
                                    <button class="qty-small-btn increase-inline">+</button>
                                </div>
                                <button class="btn btn-sm btn-primary add-to-cart">Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Product 3 -->
                    <div class="product-card" data-id="alkaline" data-price="45.00">
                        <div class="product-img">
                            <img src="../../images/galon.png" alt="Alkaline Water Gallon" class="product-image">
                        </div>
                        <div class="product-info">
                            <h3>Alkaline Water</h3>
                            <div class="price">₱45.00</div>
                            <div class="description">Higher pH for balanced health</div>
                            <div class="product-actions">
                                <div class="quantity-inline">
                                    <button class="qty-small-btn decrease-inline">-</button>
                                    <span class="qty-inline-value">1</span>
                                    <button class="qty-small-btn increase-inline">+</button>
                                </div>
                                <button class="btn btn-sm btn-primary add-to-cart">Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Product 4 -->
                    <div class="product-card" data-id="distilled" data-price="30.00">
                        <div class="product-img">
                            <img src="../../images/galon.png" alt="Distilled Water Gallon" class="product-image">
                        </div>
                        <div class="product-info">
                            <h3>Distilled Water</h3>
                            <div class="price">₱30.00</div>
                            <div class="description">Pure H2O with no minerals</div>
                            <div class="product-actions">
                                <div class="quantity-inline">
                                    <button class="qty-small-btn decrease-inline">-</button>
                                    <span class="qty-inline-value">1</span>
                                    <button class="qty-small-btn increase-inline">+</button>
                                </div>
                                <button class="btn btn-sm btn-primary add-to-cart">Add</button>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">Plastic Bottles</h3>
                <div class="products-grid">
                    <!-- Bottle Product 1 -->
                    <div class="product-card" data-id="mineral-bottle" data-price="15.00">
                        <div class="product-img">
                            <img src="../../images/plastic-bottle.png" alt="Mineral Water Bottle" class="product-image">
                        </div>
                        <div class="product-info">
                            <h3>Mineral Water Bottle</h3>
                            <div class="price">₱15.00</div>
                            <div class="description">500ml bottle with minerals</div>
                            <div class="product-actions">
                                <div class="quantity-inline">
                                    <button class="qty-small-btn decrease-inline">-</button>
                                    <span class="qty-inline-value">1</span>
                                    <button class="qty-small-btn increase-inline">+</button>
                                </div>
                                <button class="btn btn-sm btn-primary add-to-cart">Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Bottle Products 2-4 remain the same -->
                    <div class="product-card" data-id="purified-bottle" data-price="12.00">
                        <div class="product-img">
                            <img src="../../images/plastic-bottle.png" alt="Purified Water Bottle"
                                class="product-image">
                        </div>
                        <div class="product-info">
                            <h3>Purified Water Bottle</h3>
                            <div class="price">₱12.00</div>
                            <div class="description">500ml clean purified water</div>
                            <div class="product-actions">
                                <div class="quantity-inline">
                                    <button class="qty-small-btn decrease-inline">-</button>
                                    <span class="qty-inline-value">1</span>
                                    <button class="qty-small-btn increase-inline">+</button>
                                </div>
                                <button class="btn btn-sm btn-primary add-to-cart">Add</button>
                            </div>
                        </div>
                    </div>

                    <div class="product-card" data-id="alkaline-bottle" data-price="18.00">
                        <div class="product-img">
                            <img src="../../images/plastic-bottle.png" alt="Alkaline Water Bottle"
                                class="product-image">
                        </div>
                        <div class="product-info">
                            <h3>Alkaline Water Bottle</h3>
                            <div class="price">₱18.00</div>
                            <div class="description">500ml high pH water</div>
                            <div class="product-actions">
                                <div class="quantity-inline">
                                    <button class="qty-small-btn decrease-inline">-</button>
                                    <span class="qty-inline-value">1</span>
                                    <button class="qty-small-btn increase-inline">+</button>
                                </div>
                                <button class="btn btn-sm btn-primary add-to-cart">Add</button>
                            </div>
                        </div>
                    </div>

                    <div class="product-card" data-id="distilled-bottle" data-price="14.00">
                        <div class="product-img">
                            <img src="../../images/plastic-bottle.png" alt="Distilled Water Bottle"
                                class="product-image">
                        </div>
                        <div class="product-info">
                            <h3>Distilled Water Bottle</h3>
                            <div class="price">₱14.00</div>
                            <div class="description">500ml pure distilled water</div>
                            <div class="product-actions">
                                <div class="quantity-inline">
                                    <button class="qty-small-btn decrease-inline">-</button>
                                    <span class="qty-inline-value">1</span>
                                    <button class="qty-small-btn increase-inline">+</button>
                                </div>
                                <button class="btn btn-sm btn-primary add-to-cart">Add</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="cart-container" id="cart-container">
                    <div class="cart-header">
                        <h3>Your Order</h3>
                        <span class="cart-count">0</span>
                    </div>
                    <div id="cart-items">
                        <!-- Cart items will be displayed here -->
                        <div class="empty-cart">Cart is empty. Please add products.</div>
                    </div>
                    <div class="cart-footer">
                        <span>Total:</span>
                        <span id="cart-total">₱0.00</span>
                    </div>
                </div>
            </div>

            <!-- Other tabs are hidden by default -->
            <div class="tab-content" id="tab-customer" style="display: none;">
                <form id="customer-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Full Name</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" required>
                        </div>
                        <div class="form-group">
                            <label for="payment">Payment Option</label>
                            <select id="payment" required>
                                <option value="cash">Cash</option>
                                <option value="gcash">Gcash</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="delivery">Delivery Option</label>
                            <select id="delivery" required>
                                <option value="pickup">Pick-up</option>
                                <option value="delivery">Home Delivery</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="address">Address (For Delivery)</label>
                            <textarea id="address" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Payment Tab -->
            <div class="tab-content" id="tab-payment" style="display: none;">
                <div class="payment-container">
                    <div class="payment-summary">
                        <div class="summary-header">Payment Details</div>
                        <div class="summary-item">
                            <span>Order Total:</span>
                            <span id="payment-order-total">₱0.00</span>
                        </div>

                        <div class="adjustments-section">
                            <div class="form-group">
                                <label for="discount">Discount/Charge:</label>
                                <div class="input-with-icon">
                                    <select id="adjustment-type">
                                        <option value="discount">Discount</option>
                                        <option value="charge">Extra Charge</option>
                                    </select>
                                    <input type="number" id="adjustment-amount" min="0" step="1" value="0">
                                    <select id="adjustment-unit">
                                        <option value="percent">%</option>
                                        <option value="fixed">₱</option>
                                    </select>
                                    <button class="btn btn-sm btn-primary" id="apply-adjustment">Apply</button>
                                </div>
                            </div>

                            <div id="adjustments-list">
                                <!-- Adjustments will be listed here -->
                            </div>
                        </div>

                        <div class="summary-item total">
                            <span>Final Amount Due:</span>
                            <span id="final-amount">₱0.00</span>
                        </div>

                        <div class="payment-input">
                            <div class="form-group">
                                <label for="payment-amount">Payment Amount:</label>
                                <div class="input-with-icon peso-prefix">
                                    <input type="number" id="payment-amount" min="0" step="1"
                                        placeholder="Enter amount">
                                </div>
                            </div>

                            <div class="change-calculation">
                                <div class="summary-item change">
                                    <span>Change:</span>
                                    <span id="change-amount">₱0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="payment-methods">
                        <h4>Quick Payment</h4>
                        <div class="quick-payment-grid">
                            <button class="quick-payment" data-amount="100">₱100</button>
                            <button class="quick-payment" data-amount="200">₱200</button>
                            <button class="quick-payment" data-amount="500">₱500</button>
                            <button class="quick-payment" data-amount="1000">₱1000</button>
                            <button class="quick-payment exact-amount">Exact Amount</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Review Tab -->
            <div class="tab-content" id="tab-review" style="display: none;">
                <div class="order-summary">
                    <div class="summary-header">Order Summary</div>
                    <div id="summary-product-name" class="summary-item">
                        <span>Product:</span>
                        <span>Mineral Water</span>
                    </div>
                    <div id="summary-quantity" class="summary-item">
                        <span>Quantity:</span>
                        <span>1</span>
                    </div>
                    <div id="summary-price" class="summary-item">
                        <span>Price per unit:</span>
                        <span>₱35.00</span>
                    </div>
                    <div id="summary-delivery" class="summary-item">
                        <span>Delivery:</span>
                        <span>Pick-up</span>
                    </div>
                    <div id="summary-total" class="summary-item total">
                        <span>Total:</span>
                        <span>₱35.00</span>
                    </div>
                </div>

                <div class="customer-details">
                    <h4>Customer Information</h4>
                    <p id="summary-customer-name">Name: John Doe</p>
                    <p id="summary-customer-phone">Phone: 09123456789</p>
                    <p id="summary-customer-email">Email: john@example.com</p>
                    <p id="summary-customer-address">Address: N/A (Pick-up)</p>
                </div>
            </div>

            <!-- Order Success Tab -->
            <div class="tab-content" id="tab-success" style="display: none;">
                <div class="success-content">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2>Order Placed Successfully!</h2>
                    <p>Thank you for your order. Your water will be ready for pickup/delivery shortly.</p>
                    <a href="Reciept.html" class="Receipt-link">
                        <i class="fas fa-receipt"></i> Receipt
                    </a>
                </div>
            </div>
        </main> 

        <!-- Navigation Buttons -->
        <div class="nav-buttons">
            <button class="btn btn-secondary" id="prev-btn">Back</button>
            <button class="btn btn-primary" id="next-btn">Continue</button>
        </div>
    </div>

    <!-- PHP code for server-side cart processing will be added separately -->
    <!-- Add this script tag just before the closing </body> tag -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get all Add to Cart buttons
            const addToCartButtons = document.querySelectorAll('.add-to-cart');
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalElement = document.getElementById('cart-total');
            const cartCountElement = document.querySelector('.cart-count');

            // Cart data
            let cartItems = [];
            let cartTotal = 0;

            // Add event listeners to quantity buttons
            const decreaseButtons = document.querySelectorAll('.decrease-inline');
            const increaseButtons = document.querySelectorAll('.increase-inline');

            decreaseButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const qtyElement = this.nextElementSibling;
                    let currentQty = parseInt(qtyElement.textContent);
                    if (currentQty > 1) {
                        qtyElement.textContent = currentQty - 1;
                    }
                });
            });

            increaseButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const qtyElement = this.previousElementSibling;
                    let currentQty = parseInt(qtyElement.textContent);
                    qtyElement.textContent = currentQty + 1;
                });
            });

            // Add to cart functionality
            addToCartButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Get product information
                    const productCard = this.closest('.product-card');
                    const productInfo = this.closest('.product-info');
                    const productName = productInfo.querySelector('h3').textContent;
                    const priceText = productInfo.querySelector('.price').textContent;
                    const price = parseFloat(priceText.replace('₱', ''));
                    const quantityElement = productInfo.querySelector('.qty-inline-value');
                    const quantity = parseInt(quantityElement.textContent);

                    // Add to cart
                    addToCart(productName, price, quantity);

                    // Reset quantity to 1 after adding to cart
                    quantityElement.textContent = '1';
                });
            });

            function addToCart(name, price, quantity) {
                // Check if the product already exists in the cart
                const existingItemIndex = cartItems.findIndex(item => item.name === name);

                if (existingItemIndex !== -1) {
                    // Update quantity if the product already exists
                    cartItems[existingItemIndex].quantity += quantity;
                } else {
                    // Add new item to cart
                    cartItems.push({
                        name: name,
                        price: price,
                        quantity: quantity
                    });
                }

                // Update the cart UI
                updateCartUI();
            }

            // Replace the updateCartUI function with this updated version

            function updateCartUI() {
                // Clear current cart display
                cartItemsContainer.innerHTML = '';

                // If cart is empty
                if (cartItems.length === 0) {
                    cartItemsContainer.innerHTML = '<div class="empty-cart">Cart is empty. Please add products.</div>';
                    cartTotalElement.textContent = '₱0.00';
                    cartCountElement.textContent = '0';
                    recalculateFinalAmount();
                    return;
                }

                // Calculate total
                cartTotal = 0;
                let totalItems = 0;

                // Add each item to the cart
                cartItems.forEach((item, index) => {
                    const itemTotal = item.price * item.quantity;
                    cartTotal += itemTotal;
                    totalItems += item.quantity;

                    const cartItemElement = document.createElement('div');
                    cartItemElement.classList.add('cart-item');
                    cartItemElement.innerHTML = `
                        <div class="cart-item-info">
                            <div class="cart-item-details">
                                <span class="cart-item-name">${item.name}</span>
                                <span class="cart-item-quantity">Quantity: ${item.quantity}</span>
                                <span class="cart-item-price">₱${item.price.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="cart-item-actions">
                            <button class="remove-item" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;

                    cartItemsContainer.appendChild(cartItemElement);
                });

                // Add event listeners to remove buttons
                const removeButtons = document.querySelectorAll('.remove-item');
                removeButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const index = parseInt(this.getAttribute('data-index'));
                        removeFromCart(index);
                    });
                });

                // Update cart count and total
                cartCountElement.textContent = totalItems.toString();
                cartTotalElement.textContent = `₱${cartTotal.toFixed(2)}`;
            }

            function removeFromCart(index) {
                // Remove the item from the cart
                cartItems.splice(index, 1);
                // Update the cart UI
                updateCartUI();
            }

            // Add this code at the end of your existing document.addEventListener('DOMContentLoaded', function() {...}) before the closing });

            // Tab navigation functionality
            const tabButtons = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');

            // Initialize with the products tab
            let currentTabIndex = 0;
            updateNavButtons();

            // Replace the nextBtn event listener with this updated version

            // Remove both existing nextBtn event listeners and replace with this one
            nextBtn.addEventListener('click', function () {
                // When on products tab (first tab)
                if (currentTabIndex === 0) {
                    if (cartItems.length === 0) {
                        alert('Please add at least one product to your cart before continuing.');
                        return;
                    }
                    currentTabIndex++;
                    updateTabs();
                    updateNavButtons();
                    return;
                }

                // When on customer details tab (second tab)
                if (currentTabIndex === 1) {
                    const name = document.getElementById('name').value;
                    const phone = document.getElementById('phone').value;
                    const delivery = document.getElementById('delivery').value;
                    const address = document.getElementById('address').value;

                    // Validate required fields on customer tab before proceeding
                    if (!name.trim()) {
                        alert('Please enter your name');
                        return;
                    }

                    if (!phone.match(/^09\d{9}$/)) {
                        alert('Phone number must start with 09 and be exactly 11 digits');
                        return;
                    }

                    if (delivery === 'delivery' && !address.trim()) {
                        alert('Please provide a delivery address');
                        return;
                    }
                }

                // When on payment tab (third tab)
                if (currentTabIndex === 2) {
                    // Payment validation logic could go here
                }

                // When on review tab (fourth tab) - Place Order button
                if (currentTabIndex === 3 && nextBtn.textContent === 'Place Order') {
                    submitOrder();
                    return;
                }

                // Default behavior - proceed to next tab if not returned earlier
                if (currentTabIndex < tabContents.length - 1) {
                    currentTabIndex++;
                    updateTabs();
                    updateNavButtons();

                    // If moving to payment tab, update payment content
                    if (currentTabIndex === 2) {
                        updatePaymentTab();
                    }
                    // If moving to review tab, update review content
                    if (currentTabIndex === 3) {
                        updateReviewTab();
                    }
                }
            });

            // Back button functionality
            prevBtn.addEventListener('click', function () {
                if (currentTabIndex > 0) {
                    currentTabIndex--;
                    updateTabs();
                    updateNavButtons();
                }
            });

            // Tab click functionality (optional - allows clicking on tabs directly)
            tabButtons.forEach((tab, index) => {
                tab.addEventListener('click', function () {
                    // Prevent skipping to review/success without items
                    if (index > 0 && cartItems.length === 0) {
                        alert('Please add items to your cart first.');
                        return;
                    }

                    currentTabIndex = index;
                    updateTabs();
                    updateNavButtons();

                    if (currentTabIndex === 2) {
                        updatePaymentTab();
                    }
                    if (currentTabIndex === 3) {
                        updateReviewTab();
                    }
                });
            });

            function updateTabs() {
                // Update the active tab
                tabButtons.forEach((tab, index) => {
                    if (index === currentTabIndex) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });

                // Update the visible content
                tabContents.forEach((content, index) => {
                    if (index === currentTabIndex) {
                        content.style.display = 'block';
                    } else {
                        content.style.display = 'none';
                    }
                });
            }

            function updateNavButtons() {
                // Hide Back button on first tab (products)
                if (currentTabIndex === 0) {
                    prevBtn.style.display = 'none';
                } else {
                    prevBtn.style.display = 'block';
                }

                // Change Continue button text on last tab
                if (currentTabIndex === tabContents.length - 1) {
                    nextBtn.textContent = 'Place Order';
                } else {
                    nextBtn.textContent = 'Continue';
                }
            }

            function updateReviewTab() {
                // Get the review tab content container
                const reviewContainer = document.querySelector('#tab-review');
                const orderSummary = reviewContainer.querySelector('.order-summary') || document.createElement('div');

                if (!orderSummary.classList.contains('order-summary')) {
                    orderSummary.classList.add('order-summary');
                    reviewContainer.appendChild(orderSummary);
                }

                // Clear existing content
                orderSummary.innerHTML = '';

                // Add header
                const summaryHeader = document.createElement('div');
                summaryHeader.classList.add('summary-header');
                summaryHeader.textContent = 'Order Summary';
                orderSummary.appendChild(summaryHeader);

                // Add each cart item
                cartItems.forEach(item => {
                    const summaryItem = document.createElement('div');
                    summaryItem.classList.add('summary-item');

                    const itemName = document.createElement('div');
                    itemName.classList.add('item-name');
                    itemName.textContent = `${item.name} x ${item.quantity}`;

                    const itemPrice = document.createElement('div');
                    itemPrice.classList.add('item-price');
                    itemPrice.textContent = `₱${(item.price * item.quantity).toFixed(2)}`;

                    summaryItem.appendChild(itemName);
                    summaryItem.appendChild(itemPrice);
                    orderSummary.appendChild(summaryItem);
                });

                // Add total
                const totalItem = document.createElement('div');
                totalItem.classList.add('summary-item', 'total');

                const totalLabel = document.createElement('div');
                totalLabel.textContent = 'Total';

                const totalAmount = document.createElement('div');
                totalAmount.textContent = cartTotalElement.textContent;

                totalItem.appendChild(totalLabel);
                totalItem.appendChild(totalAmount);
                orderSummary.appendChild(totalItem);
            }

            function processOrder() {
                // Here you would typically send the order to the server
                // For now, we'll just navigate to the success page
                currentTabIndex = tabContents.length - 1;
                updateTabs();
                updateNavButtons();

                // Generate order number
                const orderNumber = 'RJ' + Math.floor(100000 + Math.random() * 900000);

                // Update success message with order details
                const successTab = document.querySelector('#tab-success');
                if (successTab) {
                    const orderNumberElement = successTab.querySelector('.order-number') || document.createElement('div');
                    if (!orderNumberElement.classList.contains('order-number')) {
                        orderNumberElement.classList.add('order-number');
                        successTab.querySelector('.success-content')?.appendChild(orderNumberElement);
                    }
                    orderNumberElement.textContent = orderNumber;
                }
            }

            // Handle showing/hiding the address field based on delivery option
            const deliverySelect = document.getElementById('delivery');
            const addressGroup = document.querySelector('label[for="address"]').closest('.form-group');

            // Hide address field on page load (since pickup is default)
            addressGroup.style.display = 'none';

            // Add event listener to delivery select
            deliverySelect.addEventListener('change', function () {
                if (this.value === 'pickup') {
                    // Hide address field for pickup
                    addressGroup.style.display = 'none';
                } else {
                    // Show address field for delivery
                    addressGroup.style.display = 'block';
                }
            });

            // Add this to your existing JavaScript in the DOMContentLoaded event

            // Get the phone input field
            const phoneInput = document.getElementById('phone');

            // Add input event listener for phone validation
            phoneInput.addEventListener('input', function () {
                // Remove non-digit characters
                this.value = this.value.replace(/\D/g, '');

                // Ensure it starts with 09
                if (this.value.length >= 2 && this.value.substring(0, 2) !== '09') {
                    this.value = '09' + this.value.substring(2);
                }

                // Limit to 11 digits
                if (this.value.length > 11) {
                    this.value = this.value.substring(0, 11);
                }
            });

            // Function to submit the order to PHP
            function submitOrder() {
                const name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;
                const payment = document.getElementById('payment').value;
                const delivery = document.getElementById('delivery').value;
                const address = document.getElementById('address').value;

                // Create form data
                const formData = new FormData();
                formData.append('name', name);
                formData.append('phone', phone);
                formData.append('payment', payment);
                formData.append('delivery', delivery);
                formData.append('address', address);
                formData.append('cart_total', cartTotal);

                // Add cart items to form data
                formData.append('cart_items', JSON.stringify(cartItems));

                // Send AJAX request
                fetch('../Controllers/order.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log("Order successful");
                        
                        // Navigate to success tab
                        currentTabIndex = tabContents.length - 1;
                        updateTabs();
                        updateNavButtons(); 
                        
                        // Get session username if available (or use a default)
                        // This assumes you already have this stored somewhere in your page
                        // If not, we'll just use the customer name
                        const username = window.sessionUsername || 'Customer';
                        
                        // Get current date and time
                        const orderDate = new Date().toLocaleString();
                        
                        // Prepare receipt data
                        const receiptData = {
                            orderNumber: data.order_number,
                            orderDate: orderDate,
                            customerName: name,
                            username: username,
                            customerPhone: phone,
                            paymentMethod: payment,
                            deliveryMethod: delivery,
                            customerAddress: address,
                            items: [...cartItems]
                        };
                        
                        // Update the receipt link's href to include the order data
                        const receiptLink = document.querySelector('.Receipt-link');
                        if (receiptLink) {
                            receiptLink.href = `Receipt.html?orderData=${encodeURIComponent(JSON.stringify(receiptData))}`;
                        }
                        
                        // Clear cart after successful order
                        cartItems = [];
                        updateCartUI();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('There was an error processing your order. Please try again.');
                });
            }

            function updatePaymentTab() {
                // Update the order total in the payment tab
                const paymentOrderTotal = document.getElementById('payment-order-total');
                const finalAmount = document.getElementById('final-amount');
                if (paymentOrderTotal && finalAmount) {
                    paymentOrderTotal.textContent = cartTotalElement.textContent;
                    finalAmount.textContent = cartTotalElement.textContent;
                }
                // You can also reset adjustments and payment fields here if needed
            }

            let adjustments = []; // Store all adjustments (discounts/charges)

            function recalculateFinalAmount() {
                let baseTotal = cartTotal;
                let totalAdjustment = 0;

                adjustments.forEach(adj => {
                    if (adj.unit === 'percent') {
                        let value = (baseTotal * adj.amount / 100);
                        totalAdjustment += (adj.type === 'discount' ? -value : value);
                    } else {
                        totalAdjustment += (adj.type === 'discount' ? -adj.amount : adj.amount);
                    }
                });

                let final = baseTotal + totalAdjustment;
                if (final < 0) final = 0;

                // Update UI
                document.getElementById('final-amount').textContent = `₱${final.toFixed(2)}`;
                document.getElementById('payment-order-total').textContent = `₱${baseTotal.toFixed(2)}`;
                updateAdjustmentsList();
                updateChange();
            }

            function updateAdjustmentsList() {
                const list = document.getElementById('adjustments-list');
                list.innerHTML = '';
                adjustments.forEach((adj, idx) => {
                    const div = document.createElement('div');
                    div.className = 'adjustment-item';
                    div.innerHTML = `
                        <span>${adj.type === 'discount' ? 'Discount' : 'Charge'}: ${adj.amount}${adj.unit === 'percent' ? '%' : '₱'}</span>
                        <button data-idx="${idx}" class="remove-adjustment">Remove</button>
                    `;
                    list.appendChild(div);
                });
                // Remove adjustment handler
                list.querySelectorAll('.remove-adjustment').forEach(btn => {
                    btn.onclick = function () {
                        adjustments.splice(parseInt(this.dataset.idx), 1);
                        recalculateFinalAmount();
                    };
                });
            }

            // Apply adjustment button
            document.getElementById('apply-adjustment').addEventListener('click', function (e) {
                e.preventDefault();
                const type = document.getElementById('adjustment-type').value;
                const amount = parseFloat(document.getElementById('adjustment-amount').value);
                const unit = document.getElementById('adjustment-unit').value;
                if (isNaN(amount) || amount <= 0) {
                    alert('Enter a valid amount.');
                    return;
                }
                adjustments.push({ type, amount, unit });
                recalculateFinalAmount();
            });

            function getFinalAmount() {
                // Get the numeric value from the final amount span
                const text = document.getElementById('final-amount').textContent.replace(/[₱,]/g, '');
                return parseFloat(text) || 0;
            }

            function updateChange() {
                const paymentInput = document.getElementById('payment-amount');
                const changeAmount = document.getElementById('change-amount');
                const paid = parseFloat(paymentInput.value) || 0;
                const due = getFinalAmount();
                let change = paid - due;
                if (change < 0) change = 0;
                changeAmount.textContent = `₱${change.toFixed(2)}`;
            }
            function updatePaymentTab() {
                recalculateFinalAmount();
                document.getElementById('payment-amount').value = '';
                updateChange();
            }

            // Payment input change
            document.getElementById('payment-amount').addEventListener('input', updateChange);

            // Quick payment buttons
            document.querySelectorAll('.quick-payment').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (this.classList.contains('exact-amount')) {
                        document.getElementById('payment-amount').value = getFinalAmount();
                    } else {
                        document.getElementById('payment-amount').value = this.dataset.amount;
                    }
                    updateChange();
                });
            });
        });
    </script>
</body>

</html>